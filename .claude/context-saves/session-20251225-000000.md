# Context Save: Paddle Auth Redirect Flow

**Saved**: 2025-12-25
**Project**: EstimateFast Landing Page

## Summary

Implemented a complete Paddle Checkout auth redirect flow for the landing page. After a successful Paddle payment, the user is redirected to the main app with a signed JWT-like token containing their email and plan type.

The implementation includes a Netlify serverless function (`create-checkout-token`) that generates HMAC-SHA256 signed tokens with 1-hour expiry. The Paddle checkout page (`/paddle_payment`) was updated to capture payment success events and trigger the token generation + redirect flow.

Multiple issues were debugged during testing: HTTP/HTTPS protocol mismatch with Paddle checkout (resolved by using the standalone `/paddle_payment` page), Paddle token mismatch (live vs sandbox - fixed by using `test_` token), and proxy errors with Netlify dev.

## Files Modified

- `netlify/functions/create-checkout-token.ts` - **CREATED** - Netlify function that generates signed auth tokens with email, plan, and expiry
- `src/config/paddle.config.ts` - Added `PLAN_TYPE_MAPPING`, `MAIN_APP_URL`, and `TOKEN_ENDPOINT` constants
- `src/components/PaddleCheckoutButton.tsx` - Added `generateTokenAndRedirect` function (though `/paddle_payment` page is the primary working implementation)
- `src/pages/PaddlePaymentPage.tsx` - **PRIMARY IMPLEMENTATION** - Added full token generation and redirect flow with `handlePaymentSuccess` and Paddle `eventCallback`
- `.env` - Added `AUTH_TOKEN_SECRET` and `VITE_MAIN_APP_URL`, fixed Paddle token to sandbox (`test_...`)

## Current State

**Landing page side is COMPLETE and working:**
- Paddle checkout opens successfully on `/paddle_payment` page
- Payment processes in sandbox mode
- Token is generated via Netlify function
- Redirect to main app happens with token in URL

**Pending on main app side:**
- Main app (port 3050) returns 404 for `/auth` route - this route needs to be implemented to receive and verify tokens

## Next Steps

1. Implement `/auth` route in main app (port 3050) to handle incoming tokens
2. Add token verification logic in main app using the shared secret
3. Create user session after successful token verification
4. Consider adding error handling UI for invalid/expired tokens

## Key Decisions Made

- **Token Format**: JWT-like structure using `base64url(payload).base64url(signature)` with HMAC-SHA256
- **Token Expiry**: 1 hour
- **Plan Mapping**: `starter` → `basic`, `professional` → `pro`, `agency` → `enterprise`
- **Standalone Page**: Using `/paddle_payment` as the checkout page instead of embedded component (avoids HTTPS issues in development)

## Important Code/Patterns

### Token Generation (Netlify Function)
```typescript
// netlify/functions/create-checkout-token.ts
const payload = { email, plan, exp: Math.floor(Date.now() / 1000) + 3600 };
const payloadBase64 = base64url(JSON.stringify(payload));
const signature = createHmac('sha256', secret).update(payloadBase64).digest();
const signatureBase64 = base64url(signature);
return `${payloadBase64}.${signatureBase64}`;
```

### Token Verification (for main app)
```typescript
// Decode and verify in main app
const [payloadBase64, signatureBase64] = token.split('.');
const expectedSig = createHmac('sha256', secret).update(payloadBase64).digest('base64url');
if (signatureBase64 !== expectedSig) throw new Error('Invalid signature');
const payload = JSON.parse(Buffer.from(payloadBase64, 'base64url').toString());
if (payload.exp < Date.now() / 1000) throw new Error('Token expired');
// payload contains: { email, plan, exp }
```

### Redirect URL Format
```
http://localhost:3050/auth?token=eyJlbWFpbCI6InRlc3RAZXhhbXBsZS5jb20iLCJwbGFuIjoiYmFzaWMiLCJleHAiOjE3MzUxMjM0NTZ9.abc123signature
```

## Notes

- **Auth Secret**: `AUTH_TOKEN_SECRET=a2097492d6abce20b19b4846a40c734ace6f54e7048310c2bce6201deb007330` (must be same in landing and main app)
- **Paddle Sandbox Token**: `test_3da85ec98dee6288aaa410ee359`
- **Local Testing**: Run `netlify dev` for landing page (port 8888), main app should be on port 3050
- **VITE_MAIN_APP_URL**: Currently set to `http://localhost:3050` for local testing, change to production URL for deployment
